import API from"../api";import{lpAddQueryArgs,lpFetchAPI,lpGetCurrentURLNoParam}from"../utils";import Cookies from"../utils/cookies";"undefined"!=typeof lpData&&"undefined"!=typeof lpSettingCourses||console.log("lpData || lpSettingCourses is undefined"),window.lpArchiveRequestCourse=e=>{window.lpCourseList.updateEventTypeBeforeFetch("filter"),window.lpCourseList.triggerFetchAPI(e)},document.addEventListener("change",(function(e){const t=e.target;window.lpCourseList.onChangeSortBy(e,t),window.lpCourseList.onChangeTypeLayout(e,t)})),document.addEventListener("click",(function(e){const t=e.target;window.lpCourseList.clickLoadMore(e,t),window.lpCourseList.clickNumberPage(e,t)})),document.addEventListener("scroll",(function(e){const t=e.target;window.lpCourseList.scrollInfinite(e,t)})),document.addEventListener("keyup",(function(e){const t=e.target;window.lpCourseList.searchCourse(e,t)})),document.addEventListener("submit",(function(e){const t=e.target;window.lpCourseList.searchCourse(e,t)})),window.lpCourseList=(()=>{const e="lp-archive-courses",t="learn-press-courses",r="lp-archive-course-skeleton",n=parseInt(lpSettingCourses.lpArchiveLoadAjax||0),o=1===parseInt(lpSettingCourses.lpArchiveNoLoadAjaxFirst),s=lpData.urlParams||[],a=lpGetCurrentURLNoParam();let i={};const c=lpSettingCourses.lpArchivePaginationType||"number";let l,u,d=!1;const p=(e,t={})=>{const r=lpAddQueryArgs(API.frontend.apiCourses,e);let n={};0!==parseInt(lpData.user_id)&&(n={headers:{"X-WP-Nonce":lpData.nonce}}),lpFetchAPI(r,n,t)};return{init:()=>{const e={},t=window.location.search,r=new URLSearchParams(t);for(const[t,n]of r.entries())e[t]=n;i={...s,...e},i.paged=parseInt(i.paged||1),isNaN(i.paged)&&(i.paged=1),o&&"number"!==c&&(i.paged=1),window.localStorage.setItem("lp_filter_courses",JSON.stringify(i))},updateEventTypeBeforeFetch:e=>{l=e},onChangeSortBy:(e,t)=>{t.classList.contains("courses-order-by")&&(e.preventDefault(),i.order_by=t.value,window.location.href=lpAddQueryArgs(a,i))},onChangeTypeLayout:(r,n)=>{if("lp-switch-layout-btn"!==n.getAttribute("name"))return;const o=n.closest(`.${e}`);if(!o)return;const s=o.querySelector(`.${t}`);if(!s)return;r.preventDefault();const a=n.value;a&&(s.dataset.layout=a,Cookies.set("courses-layout",a))},clickNumberPage:(t,r)=>{if(!n||parseInt(lpSettingCourses.noLoadCoursesJs))return;if(r.classList.contains("page-numbers")){if(!r.closest(`.${e}`))return;t.preventDefault();const n=i.paged;return r.classList.contains("prev")?i.paged=n-1:r.classList.contains("next")?i.paged=n+1:i.paged=parseInt(r.textContent),l="number",void window.lpCourseList.triggerFetchAPI(i)}const o=r.closest(".page-numbers");o&&(t.preventDefault(),o.click())},clickLoadMore:(r,n)=>{if(!n.classList.contains("courses-btn-load-more"))return;const o=n.closest(`.${e}`);if(!o)return;o.querySelector(`.${t}`)&&(r.preventDefault(),++i.paged,l="load-more",window.lpCourseList.triggerFetchAPI(i))},scrollInfinite:(t,r)=>{const n=document.querySelector(`.${e}`);if(!n)return;const o=n.querySelector(".courses-load-infinite");if(!o)return;new IntersectionObserver((function(e){for(const t of e)if(t.isIntersecting){if(d)return;++i.paged,l="infinite",window.lpCourseList.triggerFetchAPI(i)}})).observe(o)},triggerFetchAPI:r=>{const n=document.querySelector(`.${e}`);if(!n)return;const o=n.querySelector(`.${t}`);if(!o)return;let s;switch(i=r,l){case"load-more":s=window.lpCourseList.callBackPaginationTypeLoadMore(n,o);break;case"infinite":s=window.lpCourseList.callBackPaginationTypeInfinite(n,o);break;case"custom":s=r.customCallBack||!1;break;default:s=window.lpCourseList.callBackFilter(r,n,o)}s&&p(r,s)},callBackFilter:(t,n,o)=>{if(!o)return;const s=o.querySelector(`.${r}`);return{before:()=>{window.history.pushState("","",lpAddQueryArgs(a,t)),window.localStorage.setItem("lp_filter_courses",JSON.stringify(t)),s&&(s.style.display="block")},success:e=>{o.querySelectorAll(`:not(.${r})`).forEach((e=>{e.closest(`.${r}`)||e.remove()})),o.insertAdjacentHTML("afterbegin",e.data.content||"");const t=document.querySelector(".learn-press-pagination");t&&t.remove();const n=e.data.pagination||"";o.insertAdjacentHTML("afterend",n)},error:e=>{o.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{s&&(s.style.display="none");o.closest(`.${e}`).scrollIntoView({behavior:"smooth"})}}},callBackPaginationTypeLoadMore:(e,t)=>{if(!t||!e)return!1;const r=e.querySelector(".courses-btn-load-more");let n;return r&&(n=r.querySelector(".lp-loading-circle")),{before:()=>{r&&(n.classList.remove("hide"),r.setAttribute("disabled","disabled"))},success:e=>{t.insertAdjacentHTML("beforeend",e.data.content||""),t.insertAdjacentHTML("afterend",e.data.pagination||"")},error:e=>{t.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{r&&(n.classList.add("hide"),r.remove())}}},callBackPaginationTypeInfinite:(e,t)=>{if(!t||!t)return;const r=e.querySelector(".courses-load-infinite");if(!r)return;const n=r.querySelector(".lp-loading-circle");return d=!0,r.classList.remove("courses-load-infinite"),{before:()=>{n.classList.remove("hide")},success:e=>{t.insertAdjacentHTML("beforeend",e.data.content||""),e.data.pagination&&t.insertAdjacentHTML("afterend",e.data.pagination||"")},error:e=>{t.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{r.remove(),d=!1}}},searchCourse:(r,n)=>{if("c_search"===n.name){r.preventDefault();const e=n.closest("form.search-courses");if(!e)return;return void e.querySelector('button[type="submit"]').click()}if(!n.classList.contains("search-courses"))return;const o=n;r.preventDefault();const s=o.closest(`.${e}`);if(!s)return;if(!s.querySelector(`.${t}`))return;const a=o.querySelector("input[name=c_search]").value;(!a||a&&a.length>2)&&(void 0!==u&&clearTimeout(u),u=setTimeout((function(){l="filter",i.c_search=a,i.paged=1,window.lpCourseList.triggerFetchAPI(i)}),800))},ajaxEnableLoadPage:()=>{let n=0;if(!o){let o;const s={success:s=>{o=setInterval((function(){const a=document.querySelector(`.${r}`),i=document.querySelector(`.${e}`);let c;if(i&&(c=i.querySelector(`.${t}`)),++n,n>5e3&&clearInterval(o),c&&a){clearInterval(o),c.insertAdjacentHTML("afterbegin",s.data.content||""),a.style.display="none";const e=s.data.pagination||"";c.insertAdjacentHTML("afterend",e)}}),1)}};"number"!==c&&(i.paged=1),p(i,s)}},getFilterParams:()=>i}})(),window.lpCourseList.init(),window.lpCourseList.ajaxEnableLoadPage();